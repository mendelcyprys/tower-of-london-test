<!DOCTYPE html>
<head>
  <title>Testing...</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <svg
      version="1.1"
      viewBox="0 0 100 100"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xlink="http://www.w3.org/1999/xlink"
    >
      <image href="background.svg" x="0" y="0" height="100%" width="100%" />
    </svg>
  </div>

  <script src="d3.v7.min.js"></script>
  <script type="module">
    const colours = ["#EF3636", "#30C953", "#2C7FB7"];

    let matrix = [[1, 2], [3], []];

    function getCol(cx) {
      if (cx < 36 + 2 / 3) return 1;
      else if (cx < 63 + 1 / 3) return 2;
      else return 3;
    }

    const diff = { x: undefined, y: undefined };
    let startCol;
    let currentElement;

    function startDragging(event, d) {
      currentElement = d3.select(this);
      const cx = Number(currentElement.attr("cx"));
      startCol = getCol(cx);
      diff.x = cx - event.x;
      diff.y = Number(currentElement.attr("cy")) - event.y;
    }

    function dragging(event) {
      d3.select(this)
        .attr("cx", event.x + diff.x)
        .attr("cy", event.y + diff.y);
    }

    function endDragging(event) {
      const cx = Number(currentElement.attr("cx"));
      const end = getCol(cx) - 1;
      if (matrix[end].length < 3 - end) {
        const num = matrix[startCol - 1].pop();
        matrix[end].push(num);
      }
      render();
    }

    function render() {
      d3.select("svg")
        .selectAll("g")
        .data(matrix)
        .join("g")
        .selectAll("circle")
        .data((d, i) => d.map((x) => [x, i, d.length - 1]))
        .join("circle")
        .attr("cy", (_, j) => 80 - j * 20)
        .attr("cx", (d) => 23 + 1 / 3 + d[1] * (26 + 2 / 3))
        .attr("fill", (d) => colours[d[0] - 1])
        .attr("r", "9")
        .attr("stroke", "black")
        .attr("stroke-opacity", "0.7")
        .attr("stroke-width", "2")
        .classed("last-child", (d, j) => j === d[2])
        .on(".drag", null);

      d3.selectAll(".last-child").call(
        d3
          .drag()
          .on("start", startDragging)
          .on("drag", dragging)
          .on("end", endDragging)
      );
    }

    render();
  </script>
</body>
