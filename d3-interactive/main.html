<!DOCTYPE html>
<head>
  <title>Testing...</title>
  <style>
    body {
      margin: 0px;
    }
    svg {
      max-height: 95dvh;
      max-width: 95dvw;
    }
    .container {
      display: flex;
      flex-direction: row;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <svg
      version="1.1"
      viewBox="0 0 100 100"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xlink="http://www.w3.org/1999/xlink"
    >
      <rect
        fill="#73461F"
        height="69"
        rx="4"
        ry="4"
        width="8"
        x="19.333333333333336"
        y="25"
      />
      <rect
        fill="#73461F"
        height="49"
        rx="4"
        ry="4"
        width="8"
        x="46.0"
        y="45"
      />
      <rect
        fill="#73461F"
        height="29"
        rx="4"
        ry="4"
        width="8"
        x="72.66666666666667"
        y="65"
      />
      <rect fill="#2d5725" height="8" rx="3" ry="3" width="92" x="4" y="90" />
    </svg>
  </div>

  <script src="d3.v7.min.js"></script>
  <script type="module">
    const colours = ["#EF3636", "#30C953", "#2C7FB7"];

    let matrix = [[1, 2], [3], []];

    function getCol(cx) {
      if (cx < 36 + 2 / 3) return 1;
      else if (cx < 63 + 1 / 3) return 2;
      else return 3;
    }
    const diff = { x: undefined, y: undefined };
    let startCol;
    function startDragging(event, d) {
      const cx = Number(d3.select(this).attr("cx"));
      startCol = getCol(cx);
      diff.x = cx - event.x;
      diff.y = Number(d3.select(this).attr("cy")) - event.y;
    }

    function dragging(event) {
      d3.select(this)
        .attr("cx", event.x + diff.x)
        .attr("cy", event.y + diff.y);
    }

    function endDragging(event) {
      const cx = Number(d3.select(this).attr("cx"));
      const endCol = getCol(cx);
      reorder(startCol - 1, endCol - 1);
      render();
    }

    function reorder(start, end) {
      if (matrix[end].length < 3 - end) {
        const num = matrix[start].pop();
        matrix[end].push(num);
      }
    }

    function render() {
      d3.select("svg")
        .selectAll("g")
        .data(matrix)
        .join("g")
        .selectAll("circle")
        .data((d, i) => d.map((x) => [x, i, d.length - 1]))
        .join("circle")
        .attr("cy", (_, j) => 80 - j * 20)
        .attr("cx", (d) => 23 + 1 / 3 + d[1] * (26 + 2 / 3))
        .attr("fill", (d) => colours[d[0] - 1])
        .attr("r", "9")
        .attr("stroke", "black")
        .attr("stroke-opacity", "0.7")
        .attr("stroke-width", "2")
        .classed("last-child", (d, j) => j === d[2])
        .on(".drag", null);
      d3.selectAll(".last-child").call(
        d3
          .drag()
          .on("start", startDragging)
          .on("drag", dragging)
          .on("end", endDragging)
      );
    }

    render();
  </script>
</body>
